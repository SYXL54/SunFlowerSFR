<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>以太坊钱包认证</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js" type="application/javascript"></script>
</head>
<body>
    <h1>以太坊钱包认证</h1>
    <button id="connectButton">连接钱包</button>
    <p id="status">状态：未连接</p>

    <script>
        const fixedAddresses = [
            '0xBe9d8ED4B2D98dB55EaC4fB79D6526A9193ead49', // passportVerifier
            '0xd427aD728154c6cE616B1f9E22DEB3a995478eEB', // singPassVerifier
            '0x9Fe3C923CCdb28bCEEf34EA7f181e49e23b1a3f1'  // addressVerifier
        ];

        const contractAddress = '0xca9D5d268A61e0Eb9c0E8BAac3dD0138812Fdb58';
        const contractABI = [
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_user",
				"type": "address"
			},
			{
				"internalType": "string",
				"name": "_dataType",
				"type": "string"
			}
		],
		"name": "confirmVerification",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "_passport",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_singPass",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_addressInfo",
				"type": "string"
			}
		],
		"name": "register",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_passportVerifier",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "_singPassVerifier",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "_addressVerifier",
				"type": "address"
			}
		],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "user",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "reason",
				"type": "string"
			}
		],
		"name": "RegistrationFailed",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "user",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "passport",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "singPass",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "addressInfo",
				"type": "string"
			}
		],
		"name": "UserRegistered",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "verifier",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "user",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "dataType",
				"type": "string"
			}
		],
		"name": "VerificationConfirmed",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "user",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "dataType",
				"type": "string"
			}
		],
		"name": "VerificationRequested",
		"type": "event"
	},
	{
		"inputs": [],
		"name": "addressVerifier",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_user",
				"type": "address"
			}
		],
		"name": "checkRegistrationStatus",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "passportVerifier",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "singPassVerifier",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "users",
		"outputs": [
			{
				"internalType": "address",
				"name": "userAddress",
				"type": "address"
			},
			{
				"internalType": "string",
				"name": "passport",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "singPass",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "addressInfo",
				"type": "string"
			},
			{
				"internalType": "bool",
				"name": "passportVerified",
				"type": "bool"
			},
			{
				"internalType": "bool",
				"name": "singPassVerified",
				"type": "bool"
			},
			{
				"internalType": "bool",
				"name": "addressVerified",
				"type": "bool"
			},
			{
				"internalType": "uint256",
				"name": "registrationTime",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "isRegistered",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "verificationTimeout",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];

        const connectButton = document.getElementById('connectButton');
        const statusText = document.getElementById('status');

        connectButton.addEventListener('click', async () => {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    // 请求用户授权连接钱包
                    await window.ethereum.request({ method: 'eth_requestAccounts' });

                    // 创建以太坊提供者
                    const provider = new ethers.providers.Web3Provider(window.ethereum);

                    // 获取签名者
                    const signer = provider.getSigner();

                    // 获取钱包地址
                    const walletAddress = await signer.getAddress();
                    statusText.innerText = `状态：已连接，钱包地址：${walletAddress}`;

                    // 检查钱包地址是否在固定地址列表中
                    if (fixedAddresses.map(addr => addr.toLowerCase()).includes(walletAddress.toLowerCase())) {
                        // 创建合约实例
                        const contract = new ethers.Contract(contractAddress, contractABI, signer);

                        // 监听 VerificationRequested 事件
                        contract.on('VerificationRequested', async (userAddress, dataType) => {
                            console.log(`收到验证请求，用户地址：${userAddress}，数据类型：${dataType}`);

                            // 调用合约的 confirmVerification 方法
                            try {
                                const tx = await contract.confirmVerification(userAddress, dataType);
                                await tx.wait();
                                console.log('验证已确认');
                            } catch (error) {
                                console.error('确认验证时出错:', error);
                            }
                        });

                        console.log('事件监听已启动');
                    } else {
                        console.log('钱包地址未授权，无法启动事件监听');
                    }
                } catch (error) {
                    console.error('连接钱包时出错:', error);
                }
            } else {
                alert('请安装 MetaMask 或其他以太坊钱包插件。');
            }
        });
    </script>
</body>
</html>
